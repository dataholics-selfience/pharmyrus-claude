<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmyrus - Busca AvanÃ§ada de Patentes</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <img src="images/logo.png" alt="Pharmyrus Logo" class="logo">
            </div>
            <h1 class="title">Busca AvanÃ§ada de Patentes</h1>
            <p class="subtitle">AnÃ¡lise inteligente de portfÃ³lios de patentes farmacÃªuticas</p>
        </header>

        <div class="search-card">
            <form id="searchForm" class="search-form" autocomplete="off">
                <div class="form-group">
                    <label for="nomeMolecula" class="form-label">
                        <span class="label-icon">ğŸ§¬</span>
                        Nome da MolÃ©cula
                    </label>
                    <input 
                        type="text" 
                        id="nomeMolecula" 
                        name="molecula_<?php echo time(); ?>"
                        class="form-input" 
                        placeholder="Ex: Abemaciclib" 
                        autocomplete="off"
                        autocorrect="off"
                        autocapitalize="off"
                        spellcheck="false"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="nomeComercial" class="form-label">
                        <span class="label-icon">ğŸ’Š</span>
                        Nome Comercial
                    </label>
                    <input 
                        type="text" 
                        id="nomeComercial"
                        name="comercial_<?php echo time(); ?>"
                        class="form-input" 
                        placeholder="Ex: Verzenios"
                        autocomplete="off"
                        autocorrect="off"
                        autocapitalize="off"
                        spellcheck="false"
                        required
                    >
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-primary" id="btnSearch">ğŸ” Iniciar AnÃ¡lise</button>
                    <button type="button" class="btn-secondary" id="btnTest">ğŸ§ª Teste</button>
                </div>

                <div class="test-mode">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useTestEnv">
                        <span>Ambiente de testes</span>
                    </label>
                </div>
            </form>

            <div id="processingStatus" class="processing-status hidden">
                <div class="status-card">
                    <div class="status-spinner"></div>
                    <h3 class="status-title">Processando AnÃ¡lise</h3>
                    <p class="status-message" id="statusMessage">Aguardando webhook...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p class="status-time" id="statusTime">Tempo estimado: 3-5 minutos</p>
                </div>
            </div>

            <div id="successStatus" class="processing-status hidden" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="status-card">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">âœ…</div>
                    <h3 class="status-title">AnÃ¡lise ConcluÃ­da!</h3>
                    <p class="status-message" id="successMessage" style="margin-bottom: 2rem;">
                        Dados salvos com sucesso!
                    </p>
                    <button class="btn-primary" id="btnViewDashboard" style="font-size: 1.125rem; padding: 1rem 2rem;">
                        ğŸ“Š Ver Dashboard
                    </button>
                    <button class="btn-secondary" onclick="location.reload()" style="margin-top: 1rem;">
                        ğŸ” Nova Busca
                    </button>
                </div>
            </div>
        </div>

        <div class="features">
            <div class="feature-card">
                <div class="feature-icon">ğŸ“Š</div>
                <h3>AnÃ¡lise Completa</h3>
                <p>Busca em bases INPI e EPO</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ¯</div>
                <h3>Insights EstratÃ©gicos</h3>
                <p>Barreiras e oportunidades</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">âš¡</div>
                <h3>Resultados RÃ¡pidos</h3>
                <p>3-5 minutos</p>
            </div>
        </div>

        <footer class="footer">
            <p>&copy; 2025 Pharmyrus</p>
        </footer>
    </div>

    <script>
        console.log('ğŸš€ Pharmyrus v9 FINAL - INDEX CORRIGIDO');
        
        var WEBHOOK_PROD = 'https://primary-production-2e3b.up.railway.app/webhook/analise-patentes';
        var WEBHOOK_TEST = 'https://primary-production-2e3b.up.railway.app/webhook-test/analise-patentes';
        
        window.onload = function() {
            console.log('âœ… Iniciado');
            
            localStorage.clear();
            sessionStorage.clear();
            console.log('ğŸ§¹ Storage limpo');
            
            var form = document.getElementById('searchForm');
            var btnSearch = document.getElementById('btnSearch');
            var btnTest = document.getElementById('btnTest');
            var useTestEnv = document.getElementById('useTestEnv');
            var nomeMolecula = document.getElementById('nomeMolecula');
            var nomeComercial = document.getElementById('nomeComercial');
            var processingStatus = document.getElementById('processingStatus');
            var successStatus = document.getElementById('successStatus');
            var statusMessage = document.getElementById('statusMessage');
            var progressFill = document.getElementById('progressFill');
            var btnViewDashboard = document.getElementById('btnViewDashboard');
            
            // LIMPAR CAMPOS
            nomeMolecula.value = '';
            nomeComercial.value = '';
            
            form.onsubmit = function(e) { 
                e.preventDefault(); 
                e.stopPropagation();
                return false; 
            };
            
            btnSearch.onclick = function() {
                var mol = nomeMolecula.value.trim();
                var com = nomeComercial.value.trim();
                
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ğŸ” VALORES LIDOS:');
                console.log('MolÃ©cula:', mol);
                console.log('Comercial:', com);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                
                if (!mol || !com) { 
                    alert('Preencha todos os campos'); 
                    return; 
                }
                
                buscar(mol, com);
            };
            
            btnTest.onclick = function() {
                nomeMolecula.value = '';
                nomeComercial.value = '';
                
                setTimeout(function() {
                    nomeMolecula.value = 'Abemaciclib';
                    nomeComercial.value = 'Verzenios';
                    
                    console.log('ğŸ§ª TESTE - valores setados');
                    buscar('Abemaciclib', 'Verzenios');
                }, 100);
            };
            
            btnViewDashboard.onclick = function() {
                console.log('ğŸ“Š Abrindo dashboard...');
                window.location.href = 'dashboard.html?t=' + Date.now();
            };
            
            function buscar(mol, com) {
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ğŸš€ BUSCA INICIADA');
                console.log('MolÃ©cula:', mol);
                console.log('Comercial:', com);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                
                localStorage.clear();
                sessionStorage.clear();
                
                var url = useTestEnv.checked ? WEBHOOK_TEST : WEBHOOK_PROD;
                var dados = { 
                    nome_molecula: mol, 
                    nome_comercial: com 
                };
                
                console.log('ğŸ“¦ Payload:', JSON.stringify(dados));
                console.log('ğŸ¯ URL:', url);
                
                processingStatus.classList.remove('hidden');
                successStatus.classList.add('hidden');
                form.style.opacity = '0.5';
                form.style.pointerEvents = 'none';
                
                statusMessage.textContent = 'Enviando: ' + mol + ' / ' + com;
                progressFill.style.width = '5%';
                
                var startTime = Date.now();
                var prog = 5;
                var timer = setInterval(function() {
                    prog += 0.3;
                    if (prog <= 90) {
                        progressFill.style.width = prog + '%';
                        var elapsed = Math.floor((Date.now() - startTime) / 1000);
                        statusMessage.textContent = 'Processando ' + mol + '... ' + elapsed + 's';
                    }
                }, 2000);
                
                console.log('ğŸ“¡ Fetch START:', new Date().toLocaleTimeString());
                
                fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(dados)
                })
                .then(function(res) {
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.log('ğŸ“¡ RESPOSTA:', res.status);
                    console.log('OK:', res.ok);
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    
                    if (!res.ok) {
                        throw new Error('HTTP ' + res.status);
                    }
                    return res.json();
                })
                .then(function(resultado) {
                    clearInterval(timer);
                    
                    console.log('âœ… JSON recebido');
                    console.log('Tipo:', typeof resultado);
                    console.log('Array:', Array.isArray(resultado));
                    
                    var moleculaRecebida = 'erro';
                    
                    try {
                        if (Array.isArray(resultado) && resultado[0]) {
                            if (resultado[0].meta) {
                                moleculaRecebida = resultado[0].meta.molecula;
                            } else if (resultado[0].output) {
                                var inner = JSON.parse(resultado[0].output);
                                moleculaRecebida = inner.meta ? inner.meta.molecula : mol;
                            }
                        } else if (resultado.meta) {
                            moleculaRecebida = resultado.meta.molecula;
                        }
                    } catch (e) {
                        console.warn('Erro ao extrair molÃ©cula:', e);
                        moleculaRecebida = mol;
                    }
                    
                    console.log('ğŸ§¬ ESPERADO:', mol);
                    console.log('ğŸ§¬ RECEBIDO:', moleculaRecebida);
                    
                    progressFill.style.width = '95%';
                    statusMessage.textContent = 'Salvando ' + moleculaRecebida + '...';
                    
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    return new Promise(function(resolve) {
                        setTimeout(function() {
                            var json = JSON.stringify(
                                Array.isArray(resultado) 
                                    ? resultado 
                                    : [{ output: JSON.stringify(resultado) }]
                            );
                            
                            console.log('ğŸ’¾ Salvando:', json.length, 'bytes');
                            
                            try {
                                localStorage.setItem('patentAnalysis', json);
                                
                                var verif = localStorage.getItem('patentAnalysis');
                                if (!verif || verif.length !== json.length) {
                                    throw new Error('Falha ao salvar');
                                }
                                
                                console.log('âœ… SALVO COM SUCESSO');
                                resolve(moleculaRecebida);
                            } catch (e) {
                                console.error('âŒ Erro ao salvar:', e);
                                throw e;
                            }
                        }, 500);
                    });
                })
                .then(function(molecula) {
                    console.log('ğŸ‰ SUCESSO TOTAL');
                    
                    progressFill.style.width = '100%';
                    statusMessage.textContent = 'Redirecionando...';
                    
                    setTimeout(function() {
                        console.log('ğŸš€ Redirecionando para dashboard');
                        window.location.href = 'dashboard.html?t=' + Date.now();
                    }, 1500);
                })
                .catch(function(erro) {
                    console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.error('âŒ ERRO CRÃTICO');
                    console.error('Mensagem:', erro.message);
                    console.error('Stack:', erro.stack);
                    console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    
                    clearInterval(timer);
                    
                    processingStatus.classList.add('hidden');
                    form.style.opacity = '1';
                    form.style.pointerEvents = 'auto';
                    
                    alert('âŒ Erro: ' + erro.message + '\n\nTente novamente ou use o ambiente de teste.');
                });
            }
        };
    </script>
</body>
</html>
