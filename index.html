<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmyrus - Busca Avan√ßada de Patentes</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <img src="images/logo.png" alt="Pharmyrus Logo" class="logo">
            </div>
            <h1 class="title">Busca Avan√ßada de Patentes</h1>
            <p class="subtitle">An√°lise inteligente de portf√≥lios de patentes farmac√™uticas</p>
        </header>

        <div class="search-card">
            <form id="searchForm" class="search-form">
                <div class="form-group">
                    <label for="nomeMolecula" class="form-label">
                        <span class="label-icon">üß¨</span>
                        Nome da Mol√©cula
                    </label>
                    <input 
                        type="text" 
                        id="nomeMolecula" 
                        class="form-input"
                        placeholder="Ex: Abemaciclib"
                        required
                    >
                    <small class="form-hint">Nome cient√≠fico da subst√¢ncia ativa</small>
                </div>

                <div class="form-group">
                    <label for="nomeComercial" class="form-label">
                        <span class="label-icon">üíä</span>
                        Nome Comercial
                    </label>
                    <input 
                        type="text" 
                        id="nomeComercial" 
                        class="form-input"
                        placeholder="Ex: Verzenios"
                        required
                    >
                    <small class="form-hint">Nome comercial do medicamento</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-primary" id="btnSearch">
                        <span class="btn-icon">üîç</span>
                        Iniciar An√°lise
                    </button>
                    <button type="button" class="btn-secondary" id="btnTest">
                        <span class="btn-icon">üß™</span>
                        Teste R√°pido
                    </button>
                </div>

                <div class="test-mode">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useTestEnv">
                        <span>Usar ambiente de testes (webhook-test)</span>
                    </label>
                </div>
            </form>

            <div id="processingStatus" class="processing-status hidden">
                <div class="status-card">
                    <div class="status-spinner"></div>
                    <h3 class="status-title">Processando An√°lise</h3>
                    <p class="status-message" id="statusMessage">Aguardando resposta do webhook...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p class="status-time" id="statusTime">Tempo estimado: 3-5 minutos</p>
                    <button class="btn-cancel" id="btnCancel">Cancelar</button>
                </div>
            </div>
        </div>

        <div class="features">
            <div class="feature-card">
                <div class="feature-icon">üìä</div>
                <h3>An√°lise Completa</h3>
                <p>Busca em bases INPI e EPO com an√°lise de IA integrada</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üéØ</div>
                <h3>Insights Estrat√©gicos</h3>
                <p>Identifica√ß√£o de barreiras cr√≠ticas e oportunidades</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">‚ö°</div>
                <h3>Resultados R√°pidos</h3>
                <p>An√°lise completa em at√© 5 minutos</p>
            </div>
        </div>

        <footer class="footer">
            <p>&copy; 2025 Pharmyrus. Todos os direitos reservados.</p>
        </footer>
    </div>

    <script>
        console.log('üöÄ Pharmyrus v4.0');
        
        var WEBHOOK_PROD = 'https://primary-production-2e3b.up.railway.app/webhook/analise-patentes';
        var WEBHOOK_TEST = 'https://primary-production-2e3b.up.railway.app/webhook-test/analise-patentes';
        
        window.onload = function() {
            console.log('‚úÖ Carregado');
            localStorage.clear();
            
            var btnSearch = document.getElementById('btnSearch');
            var btnTest = document.getElementById('btnTest');
            var btnCancel = document.getElementById('btnCancel');
            var useTestEnv = document.getElementById('useTestEnv');
            var nomeMolecula = document.getElementById('nomeMolecula');
            var nomeComercial = document.getElementById('nomeComercial');
            var processingStatus = document.getElementById('processingStatus');
            var statusMessage = document.getElementById('statusMessage');
            var progressFill = document.getElementById('progressFill');
            var searchForm = document.getElementById('searchForm');
            
            searchForm.onsubmit = function(e) { e.preventDefault(); return false; };
            
            btnSearch.onclick = function() {
                console.log('üîç Buscar');
                var mol = nomeMolecula.value.trim();
                var com = nomeComercial.value.trim();
                if (!mol || !com) { alert('Preencha os campos'); return; }
                buscar(mol, com);
            };
            
            btnTest.onclick = function() {
                console.log('üß™ Teste');
                nomeMolecula.value = 'Abemaciclib';
                nomeComercial.value = 'Verzenios';
                buscar('Abemaciclib', 'Verzenios');
            };
            
            btnCancel.onclick = function() { location.reload(); };
            
            function buscar(mol, com) {
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('üöÄ BUSCA:', mol, com);
                
                var url = useTestEnv.checked ? WEBHOOK_TEST : WEBHOOK_PROD;
                var dados = { nome_molecula: mol, nome_comercial: com };
                
                console.log('URL:', url);
                
                processingStatus.classList.remove('hidden');
                searchForm.style.opacity = '0.5';
                searchForm.style.pointerEvents = 'none';
                
                statusMessage.textContent = 'Enviando requisi√ß√£o ao webhook...';
                progressFill.style.width = '5%';
                
                var prog = 5;
                var timer = setInterval(function() {
                    prog += 0.5;
                    if (prog <= 90) {
                        progressFill.style.width = prog + '%';
                        statusMessage.textContent = 'Aguardando resposta... ' + Math.floor(prog) + '%';
                    }
                }, 2000);
                
                console.log('üì° Fetch:', new Date().toLocaleTimeString());
                
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                })
                .then(function(res) {
                    console.log('üì° Resposta:', res.status, new Date().toLocaleTimeString());
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return res.json();
                })
                .then(function(resultado) {
                    console.log('‚úÖ JSON recebido');
                    
                    clearInterval(timer);
                    
                    progressFill.style.width = '95%';
                    statusMessage.textContent = 'Salvando dados...';
                    
                    localStorage.clear();
                    
                    var json = JSON.stringify(Array.isArray(resultado) ? resultado : [{ output: JSON.stringify(resultado) }]);
                    localStorage.setItem('patentAnalysis', json);
                    
                    console.log('üíæ Salvo:', json.length, 'bytes');
                    
                    var verif = localStorage.getItem('patentAnalysis');
                    if (!verif) {
                        throw new Error('Falha ao salvar');
                    }
                    console.log('‚úÖ Verificado');
                    
                    progressFill.style.width = '100%';
                    statusMessage.textContent = 'Conclu√≠do! Redirecionando...';
                    
                    setTimeout(function() {
                        console.log('üîÄ Redirecionando');
                        window.location.href = 'dashboard.html?t=' + Date.now();
                    }, 2000);
                })
                .catch(function(erro) {
                    console.error('‚ùå ERRO:', erro);
                    clearInterval(timer);
                    alert('Erro: ' + erro.message);
                    location.reload();
                });
            }
            
            console.log('‚úÖ Pronto');
        };
    </script>
</body>
</html>
