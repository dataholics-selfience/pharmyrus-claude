<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmyrus - Busca Avan√ßada de Patentes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 2rem; padding-bottom: 120px; }
        
        /* USER BAR - AGORA NO FOOTER! */
        .user-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1.5rem 3rem;
            display: none;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .user-bar.show { display: flex; }
        
        /* Logo √† esquerda */
        .header-logo {
            display: flex;
            align-items: center;
        }
        .header-logo img {
            height: 60px;
            width: auto;
        }
        
        /* User info √† direita */
        .user-info-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.125rem;
        }
        .user-details h3 {
            color: #1f2937;
            font-size: 0.9375rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        .quota-info {
            font-size: 0.8125rem;
            color: #6b7280;
        }
        .quota-info.unlimited {
            color: #059669;
            font-weight: 600;
        }
        .quota-info.warning {
            color: #dc2626;
            font-weight: 600;
        }
        .user-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .btn-sudo-admin {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: none;
            display: none;
        }
        .btn-sudo-admin.show {
            display: inline-block;
        }
        .btn-sudo-admin:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-logout {
            padding: 0.5rem 1rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .btn-logout:hover { background: #dc2626; }
        
        /* ORIGINAL CSS */
        .container { max-width: 800px; margin: 0 auto; }
        .logo-center {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .logo-center img {
            height: 80px;
            width: auto;
        }
        .title { 
            color: #1f2937; 
            font-size: 1.75rem; 
            font-weight: 700; 
            margin-bottom: 2rem;
            text-align: center;
        }
        .search-card { background: white; padding: 3rem; border-radius: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 0.875rem; }
        .label-icon { margin-right: 0.5rem; }
        .form-input { width: 100%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 1rem; }
        .form-input:focus { outline: none; border-color: #667eea; }
        .form-actions { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .btn-primary { flex: 1; padding: 1rem; background: #667eea; color: white; border: none; border-radius: 0.5rem; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-1px); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .btn-secondary { flex: 1; padding: 1rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem; font-weight: 600; font-size: 1rem; cursor: pointer; }
        .btn-secondary:hover { background: #4b5563; }
        .test-mode { text-align: center; }
        .btn-test-only {
            display: none;
        }
        .btn-test-only.show {
            display: block;
        }
        .test-mode {
            display: none;
        }
        .test-mode.show {
            display: block;
        }
        .checkbox-label { display: inline-flex; align-items: center; gap: 0.5rem; color: #6b7280; font-size: 0.875rem; cursor: pointer; }
        .processing-status { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 3rem; border-radius: 1rem; text-align: center; color: white; margin-top: 2rem; }
        .processing-status.hidden { display: none; }
        .status-card { background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 1rem; backdrop-filter: blur(10px); }
        .status-spinner { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; }
        .status-message { font-size: 1rem; margin-bottom: 1rem; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 999px; overflow: hidden; margin: 1.5rem 0; }
        .progress-fill { height: 100%; background: white; border-radius: 999px; transition: width 0.3s; }
        .status-time { font-size: 0.875rem; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-card">
            <div class="logo-center">
                <img src="images/logo.png" alt="Pharmyrus Logo">
            </div>
            <h1 class="title">Busca Avan√ßada de Patentes</h1>
            <form id="searchForm" class="search-form" autocomplete="off">
                <div class="form-group">
                    <label for="nomeMolecula" class="form-label">
                        <span class="label-icon">üß¨</span>
                        Nome da Mol√©cula
                    </label>
                    <input 
                        type="text" 
                        id="nomeMolecula" 
                        name="molecula_<?php echo time(); ?>"
                        class="form-input" 
                        placeholder="Ex: Abemaciclib" 
                        autocomplete="off"
                        autocorrect="off"
                        autocapitalize="off"
                        spellcheck="false"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="nomeComercial" class="form-label">
                        <span class="label-icon">üíä</span>
                        Nome Comercial
                    </label>
                    <input 
                        type="text" 
                        id="nomeComercial"
                        name="comercial_<?php echo time(); ?>"
                        class="form-input" 
                        placeholder="Ex: Verzenios"
                        autocomplete="off"
                        autocorrect="off"
                        autocapitalize="off"
                        spellcheck="false"
                        required
                    >
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-primary" id="btnSearch">üîç Iniciar An√°lise</button>
                    <button type="button" class="btn-secondary btn-test-only" id="btnTest">üß™ Teste</button>
                </div>

                <div class="test-mode" id="testModeContainer">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useTestEnv">
                        <span>Ambiente de testes</span>
                    </label>
                </div>
            </form>

            <div id="processingStatus" class="processing-status hidden">
                <div class="status-card">
                    <div class="status-spinner"></div>
                    <h3 class="status-title">Processando An√°lise</h3>
                    <p class="status-message" id="statusMessage">Aguardando webhook...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p class="status-time" id="statusTime">Tempo estimado: 3-5 minutos</p>
                </div>
            </div>

            <div id="successStatus" class="processing-status hidden" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="status-card">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
                    <h3 class="status-title">An√°lise Conclu√≠da!</h3>
                    <p class="status-message" id="successMessage" style="margin-bottom: 2rem;">
                        Dados salvos com sucesso!
                    </p>
                    <button class="btn-primary" id="btnViewDashboard" style="font-size: 1.125rem; padding: 1rem 2rem;">
                        üìä Ver Dashboard
                    </button>
                    <button class="btn-secondary" onclick="location.reload()" style="margin-top: 1rem;">
                        üîç Nova Busca
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- USER BAR - AGORA NO FOOTER! -->
    <footer class="user-bar" id="userBar">
        <div class="header-logo">
            <img src="images/logo.png" alt="Pharmyrus Logo">
        </div>
        <div class="user-info-container">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <h3 id="userName">Carregando...</h3>
                    <p class="quota-info" id="quotaInfo">Carregando quota...</p>
                </div>
            </div>
            <div class="user-actions">
                <a href="sudo-admin.html" class="btn-sudo-admin" id="btnSudoAdmin">üëë Sudo Admin</a>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAHq5Tvn3qZvbj1D2GJdUW-BhPWiAURBJI",
            authDomain: "patentes-51d85.firebaseapp.com",
            projectId: "patentes-51d85",
            storageBucket: "patentes-51d85.firebasestorage.app",
            messagingSenderId: "278792677855",
            appId: "1:278792677855:web:a801a4894efe7aa1bbbc6a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;

        // ==========================================
        // TRANSACTION ID FUNCTIONS
        // ==========================================
        
        function generateTransactionId(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            const second = String(date.getSeconds()).padStart(2, '0');
            const random = Math.random().toString(36).substring(2, 7).toUpperCase();
            
            return `search_${year}${month}${day}_${hour}${minute}${second}_${random}`;
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // ==========================================
        // SAVE SEARCH TO FIRESTORE
        // ==========================================
        
        async function saveSearchToFirestore(query, resultsCount = 0) {
            const now = new Date();
            const transactionId = generateTransactionId(now);
            
            try {
                console.log('üíæ Salvando busca no Firestore...');
                console.log('üîë Transaction ID:', transactionId);
                console.log('üîç Query:', query);
                
                await addDoc(collection(db, 'searches'), {
                    searchId: transactionId,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    query: query,
                    timestamp: serverTimestamp(),
                    year: now.getFullYear(),
                    month: now.getMonth() + 1,
                    week: getWeekNumber(now),
                    day: now.getDate(),
                    hour: now.getHours(),
                    minute: now.getMinutes(),
                    second: now.getSeconds(),
                    resultsCount: resultsCount
                });
                
                console.log('‚úÖ Busca salva com sucesso!');
                return transactionId;
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar busca:', error);
                throw error;
            }
        }

        // Check Auth State
        let authCheckTimeout = null;

        onAuthStateChanged(auth, async (user) => {
            console.log('üîê Auth state changed:', user ? user.email : 'null');
            
            const justLoggedIn = localStorage.getItem('pharmyrus_logged_in') === 'true';
            console.log('üíæ localStorage justLoggedIn:', justLoggedIn);
            
            if (!user && !justLoggedIn) {
                console.log('‚è≥ Usu√°rio n√£o autenticado, aguardando...');
                
                if (authCheckTimeout) {
                    clearTimeout(authCheckTimeout);
                }
                
                authCheckTimeout = setTimeout(() => {
                    if (!auth.currentUser) {
                        console.log('‚ùå Ainda n√£o autenticado ap√≥s 2s, redirecionando para login');
                        window.location.href = 'login.html';
                    }
                }, 2000);
                
                return;
            }
            
            if (user) {
                console.log('‚úÖ Usu√°rio autenticado:', user.email);
                
                localStorage.removeItem('pharmyrus_logged_in');
                
                if (authCheckTimeout) {
                    clearTimeout(authCheckTimeout);
                    authCheckTimeout = null;
                }
                
                currentUser = user;
                await loadUserData();
                document.getElementById('userBar').classList.add('show');
                initOriginalScript();
            }
        });

        // Load User Data
        async function loadUserData() {
            console.log('üìù Carregando dados do usu√°rio:', currentUser.uid);
            console.log('üìß Email do Firebase Auth:', currentUser.email);
            
            const userRef = doc(db, 'users', currentUser.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                userData = userSnap.data();
                console.log('üìä Dados do Firestore:', userData);
                console.log('üìß Email no documento:', userData.email);
                updateUserUI();
            } else {
                console.error('‚ùå Documento do usu√°rio n√£o existe no Firestore!');
                console.log('üîç UID procurado:', currentUser.uid);
            }
        }

        // Update User UI
        function updateUserUI() {
            console.log('üé® Atualizando UI com userData:', userData);
            
            const avatar = document.getElementById('userAvatar');
            const name = document.getElementById('userName');
            const quota = document.getElementById('quotaInfo');
            const btnSudoAdmin = document.getElementById('btnSudoAdmin');

            const displayText = userData.displayName || userData.email;
            console.log('üë§ Nome a exibir:', displayText);
            
            avatar.textContent = displayText.charAt(0).toUpperCase();
            name.textContent = displayText;

            if (userData.isAdmin === true) {
                console.log('üëë Usu√°rio √© ADMIN - Mostrando bot√£o Sudo Admin');
                btnSudoAdmin.classList.add('show');
                
                const btnTest = document.getElementById('btnTest');
                const testModeContainer = document.getElementById('testModeContainer');
                if (btnTest) {
                    btnTest.classList.add('show');
                    console.log('üß™ Mostrando bot√£o de Teste para admin');
                }
                if (testModeContainer) {
                    testModeContainer.classList.add('show');
                    console.log('üß™ Mostrando checkbox Ambiente de Testes para admin');
                }
            } else {
                console.log('üë§ Usu√°rio N√ÉO √© admin');
                btnSudoAdmin.classList.remove('show');
            }

            if (userData.quotaLimit === -1) {
                quota.textContent = '‚àû Consultas Ilimitadas';
                quota.classList.add('unlimited');
            } else {
                const remaining = userData.quotaLimit - userData.quotaUsed;
                quota.textContent = `${remaining}/${userData.quotaLimit} consultas restantes este m√™s`;
                
                if (remaining === 0) {
                    quota.classList.add('warning');
                    quota.textContent = '‚ö†Ô∏è Limite de consultas atingido';
                } else if (remaining <= 2) {
                    quota.classList.add('warning');
                }
            }
            
            console.log('‚úÖ UI atualizada');
        }

        // Check Quota
        async function checkQuota() {
            if (userData.quotaLimit === -1) return true;

            const remaining = userData.quotaLimit - userData.quotaUsed;
            if (remaining <= 0) {
                alert('‚ö†Ô∏è Voc√™ atingiu o limite de consultas mensais.\n\nAguarde at√© o pr√≥ximo m√™s ou entre em contato para aumentar sua quota.');
                return false;
            }

            return true;
        }

        // Decrement Quota
        async function decrementQuota() {
            if (userData.quotaLimit === -1) return;

            const userRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userRef, {
                quotaUsed: increment(1)
            });

            userData.quotaUsed++;
            updateUserUI();
        }

        // Logout
        window.logout = async function() {
            await signOut(auth);
            window.location.href = 'login.html';
        };

        // ORIGINAL SCRIPT (com tracking)
        function initOriginalScript() {
            console.log('üöÄ Pharmyrus v11 - COM TRACKING DE BUSCAS');
            
            var WEBHOOK_PROD = 'https://primary-production-2e3b.up.railway.app/webhook/analise-patentes';
            var WEBHOOK_TEST = 'https://primary-production-2e3b.up.railway.app/webhook-test/analise-patentes';
            
            console.log('‚úÖ Iniciado');
            
            var form = document.getElementById('searchForm');
            var btnSearch = document.getElementById('btnSearch');
            var btnTest = document.getElementById('btnTest');
            var useTestEnv = document.getElementById('useTestEnv');
            var nomeMolecula = document.getElementById('nomeMolecula');
            var nomeComercial = document.getElementById('nomeComercial');
            var processingStatus = document.getElementById('processingStatus');
            var successStatus = document.getElementById('successStatus');
            var statusMessage = document.getElementById('statusMessage');
            var progressFill = document.getElementById('progressFill');
            var btnViewDashboard = document.getElementById('btnViewDashboard');
            
            nomeMolecula.value = '';
            nomeComercial.value = '';
            
            form.onsubmit = function(e) { 
                e.preventDefault(); 
                e.stopPropagation();
                return false; 
            };
            
            btnSearch.onclick = async function() {
                var mol = nomeMolecula.value.trim();
                var com = nomeComercial.value.trim();
                
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('üîç VALORES LIDOS:');
                console.log('Mol√©cula:', mol);
                console.log('Comercial:', com);
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                if (!mol || !com) { 
                    alert('Preencha todos os campos'); 
                    return; 
                }
                
                if (!await checkQuota()) {
                    return;
                }
                
                buscar(mol, com);
            };
            
            btnTest.onclick = async function() {
                if (!await checkQuota()) {
                    return;
                }
                
                nomeMolecula.value = '';
                nomeComercial.value = '';
                
                setTimeout(function() {
                    nomeMolecula.value = 'Abemaciclib';
                    nomeComercial.value = 'Verzenios';
                    
                    console.log('üß™ TESTE - valores setados');
                    buscar('Abemaciclib', 'Verzenios');
                }, 100);
            };
            
            btnViewDashboard.onclick = function() {
                console.log('üìä Abrindo dashboard...');
                window.location.href = 'dashboard.html?t=' + Date.now();
            };
            
            function buscar(mol, com) {
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('üöÄ BUSCA INICIADA');
                console.log('Mol√©cula:', mol);
                console.log('Comercial:', com);
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                localStorage.clear();
                sessionStorage.clear();
                
                var url = useTestEnv.checked ? WEBHOOK_TEST : WEBHOOK_PROD;
                var dados = { 
                    nome_molecula: mol, 
                    nome_comercial: com 
                };
                
                console.log('üì¶ Payload:', JSON.stringify(dados));
                console.log('üéØ URL:', url);
                
                processingStatus.classList.remove('hidden');
                successStatus.classList.add('hidden');
                form.style.opacity = '0.5';
                form.style.pointerEvents = 'none';
                
                statusMessage.textContent = 'Enviando: ' + mol + ' / ' + com;
                progressFill.style.width = '5%';
                
                var startTime = Date.now();
                var prog = 5;
                var timer = setInterval(function() {
                    prog += 0.3;
                    if (prog <= 90) {
                        progressFill.style.width = prog + '%';
                        var elapsed = Math.floor((Date.now() - startTime) / 1000);
                        statusMessage.textContent = 'Processando ' + mol + '... ' + elapsed + 's';
                    }
                }, 2000);
                
                console.log('üì° Fetch START:', new Date().toLocaleTimeString());
                
                fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(dados)
                })
                .then(function(res) {
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('üì° RESPOSTA:', res.status);
                    console.log('OK:', res.ok);
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    
                    if (!res.ok) {
                        throw new Error('HTTP ' + res.status);
                    }
                    return res.json();
                })
                .then(function(resultado) {
                    clearInterval(timer);
                    
                    console.log('‚úÖ JSON recebido');
                    console.log('Tipo:', typeof resultado);
                    console.log('Array:', Array.isArray(resultado));
                    
                    var moleculaRecebida = 'erro';
                    
                    try {
                        if (Array.isArray(resultado) && resultado[0]) {
                            if (resultado[0].meta) {
                                moleculaRecebida = resultado[0].meta.molecula;
                            } else if (resultado[0].output) {
                                var inner = JSON.parse(resultado[0].output);
                                moleculaRecebida = inner.meta ? inner.meta.molecula : mol;
                            }
                        } else if (resultado.meta) {
                            moleculaRecebida = resultado.meta.molecula;
                        }
                    } catch (e) {
                        console.warn('Erro ao extrair mol√©cula:', e);
                        moleculaRecebida = mol;
                    }
                    
                    console.log('üß¨ ESPERADO:', mol);
                    console.log('üß¨ RECEBIDO:', moleculaRecebida);
                    
                    progressFill.style.width = '95%';
                    statusMessage.textContent = 'Salvando ' + moleculaRecebida + '...';
                    
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    return new Promise(function(resolve) {
                        setTimeout(async function() {
                            var json = JSON.stringify(
                                Array.isArray(resultado) 
                                    ? resultado 
                                    : [{ output: JSON.stringify(resultado) }]
                            );
                            
                            console.log('üíæ Salvando:', json.length, 'bytes');
                            
                            try {
                                localStorage.setItem('patentAnalysis', json);
                                
                                var verif = localStorage.getItem('patentAnalysis');
                                if (!verif || verif.length !== json.length) {
                                    throw new Error('Falha ao salvar');
                                }
                                
                                console.log('‚úÖ SALVO COM SUCESSO');
                                
                                // SALVAR BUSCA NO FIRESTORE COM TRANSACTION ID
                                const searchQuery = `${mol} (${com})`;
                                const resultsCount = Array.isArray(resultado) ? resultado.length : 1;
                                
                                try {
                                    const txId = await saveSearchToFirestore(searchQuery, resultsCount);
                                    console.log('üíæ Busca registrada no Firestore:', txId);
                                } catch (err) {
                                    console.error('‚ö†Ô∏è Erro ao salvar busca (n√£o cr√≠tico):', err);
                                }
                                
                                // DECREMENTAR QUOTA
                                await decrementQuota();
                                console.log('üìä Quota decrementada');
                                
                                resolve(moleculaRecebida);
                            } catch (e) {
                                console.error('‚ùå Erro ao salvar:', e);
                                throw e;
                            }
                        }, 500);
                    });
                })
                .then(function(molecula) {
                    console.log('üéâ SUCESSO TOTAL');
                    
                    progressFill.style.width = '100%';
                    statusMessage.textContent = 'Redirecionando...';
                    
                    setTimeout(function() {
                        console.log('üöÄ Redirecionando para dashboard');
                        window.location.href = 'dashboard.html?t=' + Date.now();
                    }, 1500);
                })
                .catch(function(erro) {
                    console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.error('‚ùå ERRO CR√çTICO');
                    console.error('Mensagem:', erro.message);
                    console.error('Stack:', erro.stack);
                    console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    
                    clearInterval(timer);
                    
                    processingStatus.classList.add('hidden');
                    form.style.opacity = '1';
                    form.style.pointerEvents = 'auto';
                    
                    alert('‚ùå Erro: ' + erro.message + '\n\nTente novamente ou use o ambiente de teste.');
                });
            }
        }
    </script>
</body>
</html>
