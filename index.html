<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmyrus - Busca Avan√ßada de Patentes</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <img src="images/logo.png" alt="Pharmyrus Logo" class="logo">
            </div>
            <h1 class="title">Busca Avan√ßada de Patentes</h1>
            <p class="subtitle">An√°lise inteligente de portf√≥lios de patentes farmac√™uticas</p>
        </header>

        <!-- Formul√°rio de Busca -->
        <div class="search-card">
            <form id="searchForm" class="search-form">
                <div class="form-group">
                    <label for="nomeMolecula" class="form-label">
                        <span class="label-icon">üß¨</span>
                        Nome da Mol√©cula
                    </label>
                    <input 
                        type="text" 
                        id="nomeMolecula" 
                        name="nome_molecula"
                        class="form-input"
                        placeholder="Ex: Abemaciclib"
                        required
                    >
                    <small class="form-hint">Nome cient√≠fico da subst√¢ncia ativa</small>
                </div>

                <div class="form-group">
                    <label for="nomeComercial" class="form-label">
                        <span class="label-icon">üíä</span>
                        Nome Comercial
                    </label>
                    <input 
                        type="text" 
                        id="nomeComercial" 
                        name="nome_comercial"
                        class="form-input"
                        placeholder="Ex: Verzenios"
                        required
                    >
                    <small class="form-hint">Nome comercial do medicamento</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-primary" id="btnSearch">
                        <span class="btn-icon">üîç</span>
                        Iniciar An√°lise
                    </button>
                    <button type="button" class="btn-secondary" id="btnTest">
                        <span class="btn-icon">üß™</span>
                        Teste R√°pido
                    </button>
                </div>

                <!-- Ambiente de Teste -->
                <div class="test-mode">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useTestEnv">
                        <span>Usar ambiente de testes (webhook-test)</span>
                    </label>
                </div>
            </form>

            <!-- Status de Processamento -->
            <div id="processingStatus" class="processing-status hidden">
                <div class="status-card">
                    <div class="status-spinner"></div>
                    <h3 class="status-title">Processando An√°lise</h3>
                    <p class="status-message" id="statusMessage">
                        Buscando patentes e gerando an√°lise IA...
                    </p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p class="status-time" id="statusTime">Tempo estimado: 3-5 minutos</p>
                    <button class="btn-cancel" id="btnCancel">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Features -->
        <div class="features">
            <div class="feature-card">
                <div class="feature-icon">üìä</div>
                <h3>An√°lise Completa</h3>
                <p>Busca em bases INPI e EPO com an√°lise de IA integrada</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üéØ</div>
                <h3>Insights Estrat√©gicos</h3>
                <p>Identifica√ß√£o de barreiras cr√≠ticas e oportunidades</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">‚ö°</div>
                <h3>Resultados R√°pidos</h3>
                <p>An√°lise completa em at√© 5 minutos</p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Pharmyrus. Todos os direitos reservados.</p>
        </footer>
    </div>

<script>
console.log('üöÄ INICIADO');

const WEBHOOK_PROD = 'https://primary-production-2e3b.up.railway.app/webhook/analise-patentes';
const WEBHOOK_TEST = 'https://primary-production-2e3b.up.railway.app/webhook-test/analise-patentes';
const TIMEOUT = 360000;

window.onload = function() {
    console.log('‚úÖ P√°gina carregada');
    
    localStorage.clear();
    console.log('üßπ Cache limpo');
    
    const btnSearch = document.getElementById('btnSearch');
    const btnTest = document.getElementById('btnTest');
    const btnCancel = document.getElementById('btnCancel');
    const useTestEnv = document.getElementById('useTestEnv');
    const nomeMolecula = document.getElementById('nomeMolecula');
    const nomeComercial = document.getElementById('nomeComercial');
    const processingStatus = document.getElementById('processingStatus');
    const statusMessage = document.getElementById('statusMessage');
    const progressFill = document.getElementById('progressFill');
    const statusTime = document.getElementById('statusTime');
    const searchForm = document.getElementById('searchForm');
    
    console.log('Bot√£o:', btnSearch);
    
    if (!btnSearch) {
        console.error('‚ùå Bot√£o n√£o encontrado!');
        alert('ERRO: Bot√£o n√£o encontrado!');
        return;
    }
    
    searchForm.onsubmit = function(e) {
        e.preventDefault();
        return false;
    };
    
    btnSearch.onclick = function() {
        console.log('üîç CLIQUE DETECTADO!');
        
        const mol = nomeMolecula.value.trim();
        const com = nomeComercial.value.trim();
        
        console.log('Mol√©cula:', mol);
        console.log('Comercial:', com);
        
        if (!mol || !com) {
            alert('Preencha os campos!');
            return;
        }
        
        buscar(mol, com);
    };
    
    btnTest.onclick = function() {
        console.log('üß™ TESTE CLICADO!');
        nomeMolecula.value = 'Abemaciclib';
        nomeComercial.value = 'Verzenios';
        buscar('Abemaciclib', 'Verzenios');
    };
    
    btnCancel.onclick = function() {
        console.log('‚ùå CANCELAR');
        location.reload();
    };
    
    function buscar(mol, com) {
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('üöÄ BUSCA INICIADA');
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        
        const url = useTestEnv.checked ? WEBHOOK_TEST : WEBHOOK_PROD;
        const dados = { nome_molecula: mol, nome_comercial: com };
        
        console.log('URL:', url);
        console.log('Dados:', dados);
        
        processingStatus.classList.remove('hidden');
        searchForm.style.opacity = '0.5';
        searchForm.style.pointerEvents = 'none';
        
        statusMessage.textContent = 'Enviando requisi√ß√£o...';
        progressFill.style.width = '10%';
        
        let progresso = 10;
        const intervalo = setInterval(function() {
            progresso += 1;
            if (progresso <= 85) {
                progressFill.style.width = progresso + '%';
                statusMessage.textContent = 'Processando... ' + progresso + '%';
            }
        }, 3000);
        
        console.log('üì° Enviando fetch...');
        
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        })
        .then(function(response) {
            console.log('üì° Resposta recebida:', response.status);
            
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            
            return response.json();
        })
        .then(function(resultado) {
            console.log('‚úÖ JSON OK:', resultado);
            
            clearInterval(intervalo);
            
            statusMessage.textContent = 'Salvando...';
            progressFill.style.width = '95%';
            
            localStorage.clear();
            
            const json = JSON.stringify(Array.isArray(resultado) ? resultado : [{ output: JSON.stringify(resultado) }]);
            localStorage.setItem('patentAnalysis', json);
            
            console.log('üíæ Salvo:', json.length, 'bytes');
            
            statusMessage.textContent = 'Redirecionando...';
            progressFill.style.width = '100%';
            
            setTimeout(function() {
                console.log('üîÄ Redirecionando...');
                window.location.href = 'dashboard.html?t=' + Date.now();
            }, 1500);
        })
        .catch(function(erro) {
            console.error('‚ùå ERRO:', erro);
            clearInterval(intervalo);
            alert('Erro: ' + erro.message);
            location.reload();
        });
    }
    
    console.log('‚úÖ TUDO PRONTO!');
};
</script>

