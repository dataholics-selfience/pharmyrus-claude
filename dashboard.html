<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pharmyrus Dashboard - Patentes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen">
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-blue-700">ðŸ“Š Pharmyrus Dashboard</h1>
    <button id="btnExportarPDF"
      class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
      Exportar PDF
    </button>
  </header>

  <main class="max-w-7xl mx-auto p-4">
    <!-- Filtros -->
    <div class="bg-white p-4 rounded-xl shadow mb-6 flex flex-col sm:flex-row sm:items-end gap-4">
      <div class="flex-1">
        <label class="block text-sm font-medium">Buscar</label>
        <input id="inputBusca" type="text" placeholder="Digite parte do tÃ­tulo, fonte, tipo..."
          class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring focus:ring-blue-300" />
      </div>

      <div>
        <label class="block text-sm font-medium">Fonte</label>
        <select id="selectFonte" class="border border-gray-300 rounded-lg p-2 w-40">
          <option value="">Todas</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium">Tipo</label>
        <select id="selectTipo" class="border border-gray-300 rounded-lg p-2 w-40">
          <option value="">Todos</option>
        </select>
      </div>

      <button id="btnLimparFiltros"
        class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Limpar</button>
    </div>

    <!-- Tabela -->
    <div id="tabelaContainer" class="bg-white rounded-xl shadow overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
          <tr>
            <th class="px-4 py-2 text-left">Fonte</th>
            <th class="px-4 py-2 text-left">NÃºmero</th>
            <th class="px-4 py-2 text-left">TÃ­tulo</th>
            <th class="px-4 py-2 text-left">Ano</th>
            <th class="px-4 py-2 text-left">Tipo</th>
            <th class="px-4 py-2 text-left">AmeaÃ§a</th>
          </tr>
        </thead>
        <tbody id="tabelaPatentes" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </main>

  <script>
    // Helper: extrai texto de objetos complexos (corrige [object Object])
    function formatTitle(t) {
      if (!t && t !== 0) return 'Sem tÃ­tulo';
      if (typeof t === 'string') return t;
      if (typeof t === 'number') return String(t);
      if (Array.isArray(t)) return t.map(formatTitle).filter(Boolean).join(' â€” ');
      if (typeof t === 'object') {
        const tryKeys = ['titulo', 'title', 'label', 'text', 'plain', 'value', 'descricao', 'description'];
        for (const k of tryKeys) {
          if (k in t) {
            const v = t[k];
            if (typeof v === 'string' && v.trim()) return v;
            if (v) return formatTitle(v);
          }
        }
        const leafs = [];
        (function walk(o) {
          if (!o && o !== 0) return;
          if (typeof o === 'string') { if (o.trim()) leafs.push(o.trim()); return; }
          if (typeof o === 'number') { leafs.push(String(o)); return; }
          if (Array.isArray(o)) { o.forEach(walk); return; }
          if (typeof o === 'object') { Object.values(o).forEach(walk); }
        })(t);
        if (leafs.length) return leafs.join(' â€” ');
        try { return JSON.stringify(t); } catch { return String(t); }
      }
      return String(t);
    }

    const tabela = document.getElementById('tabelaPatentes');
    const inputBusca = document.getElementById('inputBusca');
    const selectFonte = document.getElementById('selectFonte');
    const selectTipo = document.getElementById('selectTipo');
    const btnLimpar = document.getElementById('btnLimparFiltros');
    const btnExportar = document.getElementById('btnExportarPDF');

    let patentes = [];

    function carregarPatentes() {
      try {
        const data = JSON.parse(localStorage.getItem('patentAnalysis') || '[]');
        // Ordena com INPI (BR) primeiro
        patentes = data.sort((a, b) => {
          const aINPI = (a.fonte || '').toLowerCase().includes('inpi');
          const bINPI = (b.fonte || '').toLowerCase().includes('inpi');
          if (aINPI && !bINPI) return -1;
          if (!aINPI && bINPI) return 1;
          return 0;
        });
        preencherFiltros();
        renderizarTabela();
      } catch (e) {
        console.error('Erro ao carregar dados do localStorage', e);
      }
    }

    function preencherFiltros() {
      const fontes = [...new Set(patentes.map(p => p.fonte).filter(Boolean))];
      const tipos = [...new Set(patentes.map(p => p.tipo).filter(Boolean))];

      selectFonte.innerHTML = '<option value="">Todas</option>' +
        fontes.map(f => `<option value="${f}">${f}</option>`).join('');
      selectTipo.innerHTML = '<option value="">Todos</option>' +
        tipos.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    function renderizarTabela() {
      const busca = inputBusca.value.toLowerCase();
      const filtroFonte = selectFonte.value;
      const filtroTipo = selectTipo.value;

      tabela.innerHTML = '';

      patentes.filter(p => {
        const titulo = formatTitle(p.titulo).toLowerCase();
        const fonte = (p.fonte || '').toLowerCase();
        const tipo = (p.tipo || '').toLowerCase();

        return (
          (!filtroFonte || p.fonte === filtroFonte) &&
          (!filtroTipo || p.tipo === filtroTipo) &&
          (titulo.includes(busca) || fonte.includes(busca) || tipo.includes(busca))
        );
      }).forEach(p => {
        const tr = document.createElement('tr');
        const fonteDisplay = p.fonte || '-';
        const tipoDisplay = p.tipo || '-';
        const badgeClass = fonteDisplay.toLowerCase().includes('inpi')
          ? 'bg-blue-100 text-blue-800'
          : 'bg-gray-100 text-gray-800';
        const ameacaBadge = p.ameaca
          ? `<span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-800">${p.ameaca}</span>`
          : '-';

        const tituloDisplay = formatTitle(p.titulo).substring(0, 100);

        tr.innerHTML = `
          <td class="px-4 py-2"><span class="px-2 py-1 rounded-full text-xs ${badgeClass}">${fonteDisplay}</span></td>
          <td class="px-4 py-2"><code>${p.numero_completo || p.numero || '-'}</code></td>
          <td class="px-4 py-2">${tituloDisplay}</td>
          <td class="px-4 py-2">${p.ano_deposito || p.ano || '-'}</td>
          <td class="px-4 py-2">${tipoDisplay}</td>
          <td class="px-4 py-2">${ameacaBadge}</td>
        `;
        tabela.appendChild(tr);
      });
    }

    inputBusca.addEventListener('input', renderizarTabela);
    selectFonte.addEventListener('change', renderizarTabela);
    selectTipo.addEventListener('change', renderizarTabela);
    btnLimpar.addEventListener('click', () => {
      inputBusca.value = '';
      selectFonte.value = '';
      selectTipo.value = '';
      renderizarTabela();
    });

    btnExportar.addEventListener('click', () => {
      const opt = {
        margin: 0.5,
        filename: 'pharmyrus_patentes.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(document.body).save();
    });

    carregarPatentes();
  </script>
</body>
</html>
