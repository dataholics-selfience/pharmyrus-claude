function safeText(x, fallback='-') {
    if (x == null) return fallback;
    if (typeof x === 'string') return x;
    if (typeof x === 'object') return x.title || x.titulo || JSON.stringify(x);
    return String(x);
}

function carregar() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const content = document.getElementById('content');

    let stored;
    try {
        stored = localStorage.getItem('patentAnalysis');
        if (!stored) throw new Error('Nenhum dado encontrado no localStorage.');
        stored = JSON.parse(stored);
    } catch (e) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('errorMsg').textContent = e.message;
        return;
    }

    let dados;
    try {
        dados = Array.isArray(stored) && stored[0]?.output ? JSON.parse(stored[0].output) : stored[0] || stored;
    } catch (e) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('errorMsg').textContent = 'Erro ao processar dados: ' + e.message;
        return;
    }

    // HEADER
    document.getElementById('title').textContent = safeText(dados.meta?.nome_comercial, 'Dashboard');
    document.getElementById('subtitle').textContent = 'Análise de Portfólio de Patentes';
    document.getElementById('moleculaName').textContent = safeText(dados.meta?.molecula);
    document.getElementById('comercialName').textContent = safeText(dados.meta?.nome_comercial);
    document.getElementById('classeName').textContent = safeText(dados.meta?.classe_terapeutica);

    // CARDS
    const estat = dados.estatisticas || {};
    const totalPatentes = estat.total_patentes || 0;
    const porFonte = estat.por_fonte || {};
    document.getElementById('totalPatentes').textContent = totalPatentes;
    document.getElementById('fontes').textContent = 'INPI: ' + (porFonte.INPI || 0) + ' | EPO: ' + (porFonte.EPO || 0);

    const metricas = dados.metricas_chave || {};
    document.getElementById('anosProtecao').textContent = metricas.anos_protecao_restantes || 0;
    document.getElementById('altaAmeaca').textContent = metricas.patentes_alta_ameaca || 0;

    const topTitulares = estat.top_titulares || [];
    if (topTitulares.length > 0) {
        const top = topTitulares[0];
        document.getElementById('titular').textContent = safeText(top.titular, 'N/A').substring(0, 20);
        document.getElementById('titularPerc').textContent = (top.percentual || 0) + '% do total';
    } else {
        document.getElementById('titular').textContent = 'N/A';
        document.getElementById('titularPerc').textContent = '-';
    }

    // RELATÓRIO EXECUTIVO
    const rel = dados.relatorio_executivo || {};
    document.getElementById('panorama').textContent = safeText(rel.panorama_geral, 'Não disponível');
    document.getElementById('titularDesc').textContent = safeText(rel.titular_dominante, 'Não disponível');
    document.getElementById('barreiras').textContent = safeText(rel.barreiras_criticas, 'Não disponível');
    document.getElementById('janelas').textContent = safeText(rel.janelas_oportunidade, 'Não disponível');

    // PATENTES
    todasPatentes = Array.isArray(dados.patentes) ? dados.patentes : [];
    filtrarPatentes();

    // Mostrar conteúdo
    loading.classList.add('hidden');
    content.style.display = 'block';
}
